import pandas as pd
import ipaddress
import socket

def get_fqdn(ip):
    """Perform a DNS lookup to get the FQDN for an IP."""
    try:
        return socket.getfqdn(ip)
    except socket.error:
        return "DNS Lookup Failed"

def process_cidr_ranges(input_csv, output_excel):
    # Read the input CSV file
    data = pd.read_csv(input_csv)
    
    # Validate required column
    if 'CIDR' not in data.columns:
        raise ValueError("CSV must contain a 'CIDR' column.")
    
    results = []
    for _, row in data.iterrows():
        cidr = row['CIDR']
        try:
            # Generate all IPs within the CIDR range
            network = ipaddress.ip_network(cidr, strict=False)
            for ip in network.hosts():  # Skip network and broadcast addresses
                fqdn = get_fqdn(str(ip))
                # Append results
                results.append({'CIDR': cidr, 'IP': str(ip), 'FQDN': fqdn})
        except ValueError as e:
            # Handle invalid CIDR entries
            results.append({'CIDR': cidr, 'IP': 'Invalid CIDR', 'FQDN': str(e)})
    
    # Write results to an Excel file
    result_df = pd.DataFrame(results)
    result_df.to_excel(output_excel, index=False)
    print(f"Results written to {output_excel}")

# Specify input and output files
input_csv_file = "cidr_ranges.csv"  # Input CSV with a 'CIDR' column
output_excel_file = "dns_lookup_results.xlsx"  # Output Excel file

# Process the CIDR ranges
process_cidr_ranges(input_csv_file, output_excel_file)

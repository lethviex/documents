import pandas as pd

def process_csv(input_file, output_file):
    # Read the CSV file into a DataFrame
    df = pd.read_csv(input_file)

    # Function to process each row
    def process_row(row):
        results = row['results'].split('\n')
        
        # Filter out the "Service Name     Image Path" line
        results = [line for line in results if line.strip() != "Service Name     Image Path"]

        # If results have more than 5 lines, replace with "TBD"
        if len(results) > 5:
            return ["TBD"]
        
        # If a line starts with "KB" and ends with "is not installed", merge with pipe delimiter
        if any(line.startswith("KB") and line.endswith("is not installed") for line in results):
            return [" | ".join(results)]
        
        # Return the split lines otherwise
        return results

    # Apply the processing to each row and explode the DataFrame
    df['results'] = df.apply(process_row, axis=1)
    df = df.explode('results').reset_index(drop=True)

    # Save the processed DataFrame to a new CSV file
    df.to_csv(output_file, index=False)

# Usage
input_file = 'input.csv'
output_file = 'output.csv'
process_csv(input_file, output_file)

import pandas as pd

def process_results_column(results):
    lines = results.split('\n')
    
    # Condition 1: Replace value with "TBD" if more than 5 lines
    if len(lines) > 5:
        return ["TBD"]
    
    processed_lines = []
    kb_lines = []
    
    for line in lines:
        # Condition 2: Ignore specific line
        if line.strip() == "Service Name     Image Path":
            continue
        
        # Condition 3: Merge lines starting with "KB" and ending with "is not installed"
        if line.startswith("KB") and line.endswith("is not installed"):
            kb_lines.append(line)
        else:
            if kb_lines:
                processed_lines.append(" | ".join(kb_lines))
                kb_lines = []
            processed_lines.append(line)
    
    if kb_lines:
        processed_lines.append(" | ".join(kb_lines))
    
    return processed_lines

def process_chunk(chunk):
    new_rows = []

    for _, row in chunk.iterrows():
        processed_lines = process_results_column(row['results'])
        for line in processed_lines:
            new_row = row.copy()
            new_row['results'] = line
            new_rows.append(new_row)

    return pd.DataFrame(new_rows)

# Reading and processing the CSV in chunks
chunk_size = 10000  # Adjust chunk size based on available memory
csv_file = "input.csv"
output_file = "output.csv"

reader = pd.read_csv(csv_file, chunksize=chunk_size)
first_chunk = True

for chunk in reader:
    processed_chunk = process_chunk(chunk)
    
    if first_chunk:
        processed_chunk.to_csv(output_file, index=False, mode='w')
        first_chunk = False
    else:
        processed_chunk.to_csv(output_file, index=False, mode='a', header=False)

print("Processing complete. Output saved to", output_file)
